#!/usr/bin/env bash

set -e
set -u
set -o pipefail

export STACK_WORKDIR=$(realpath $(dirname $(realpath $0))/../) 
export STACK_INC_DIR=$STACK_WORKDIR/bin/inc

source $STACK_INC_DIR/config 
source $STACK_INC_DIR/functions

if [ ! -f $STACK_ENV_FILE ] && [ "$1" != "init" ]; then
    error "Could not locate .env file ($STACK_ENV_FILE)"
elif [ -f $STACK_ENV_FILE ]; then 
    source $STACK_ENV_FILE
    source $STACK_INC_DIR/defaults 
fi

case $1 in
    init)
        init
        ;;
    up)
        dockerCompose up "${@:2}"
        ;;
    down)
        dockerCompose down --remove-orphans "${@:2}"
        ;;
    logs)
        dockerCompose logs --tail 25 --follow "${@:2}"
        ;;
    list)
        dockerCompose ps -a
        ;;
    compose)
        dockerCompose "${@:2}"
        ;;    
    backup)
        backup || error "Backup failed, please check the configuration."
        ;;
    *)
        dockerCompose exec runtime "$@"
esac
