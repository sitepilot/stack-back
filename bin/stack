#!/usr/bin/env bash

set -e
set -u
set -o pipefail

export STACK_UID=`id -u`
export STACK_WORKDIR=$(realpath $(dirname $(realpath $0))/../) 
export STACK_PROJECT_DIR=$(pwd)
export STACK_INC_DIR=$STACK_WORKDIR/bin/inc
export STACK_STUBS_DIR=$STACK_WORKDIR/stubs
export STACK_DATA_DIR=$STACK_PROJECT_DIR/.stack
export STACK_PROJECT_NAME="$(basename $STACK_PROJECT_DIR)"
export STACK_ENV_FILE=$STACK_PROJECT_DIR/.env
export STACK_CONTAINER_DATA_DIR="/opt/stack/data"
export STACK_CONTAINER_PUBLIC_DIR="/home/runtime/public"

source $STACK_INC_DIR/functions

if [ ! -f $STACK_ENV_FILE ] && [ "$1" != "init" ]; then
    error "Could not locate .env file ($STACK_ENV_FILE)"
elif [ -f $STACK_ENV_FILE ]; then 
    source $STACK_ENV_FILE && source $STACK_INC_DIR/defaults && source $STACK_ENV_FILE
fi

case $1 in
    init)
        init
        ;;
    up)
        dockerCompose up "${@:2}"
        ;;
    down)
        dockerCompose down --remove-orphans "${@:2}"
        ;;
    logs)
        dockerCompose logs --tail 25 --follow "${@:2}"
        ;;
    list)
        dockerCompose ps -a
        ;;
    compose)
        dockerCompose "${@:2}"
        ;;    
    backup)
        backup || error "Backup failed, please check the configuration."
        ;;
    *)
        dockerCompose exec runtime "$@"
esac
